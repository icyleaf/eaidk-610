#==========================================================================
# Description: Build EAIDK-610 Armbian with RKMPP Support
# Optimized for: Jellyfin Hardware Acceleration (/dev/mpp_service)
#==========================================================================

name: Build EAIDK-610 legacy armbian

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      set_release:
        description: "Select OS Release"
        required: false
        default: "bookworm"
        type: choice
        options:
          - bullseye
          - jammy
          - bookworm
      armbian_kernel:
        description: "Select Kernel (Must be rk3399 for MPP)"
        required: false
        default: "6.1.y_rk3399"
        type: choice
        options:
          - 5.10.y_rk3399
          - 6.1.y_rk3399
          - 6.6.y_rk3399

env:
  TZ: Asia/Shanghai
  ROOTFS_SCRIPT: compile-kernel/tools/script/docker/build_armbian_rootfs_file.sh

jobs:
  build:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id == github.event.sender.id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization Environment
        id: init
        run: |
          sudo -E apt-get -y update
          sudo -E apt-get -y install $(curl -fsSL https://tinyurl.com/ubuntu2204-build-armbian)
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Create Simulated Physical Disk
        run: |
          sudo truncate -s 20G /mnt/mnt.img
          sudo truncate -s 20G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6 /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /builder
          sudo mount /dev/github/runner /builder
          sudo chown -R runner.runner /builder

      - name: Download Armbian Builder
        id: down
        working-directory: /builder
        run: |
          git clone -q --single-branch --depth=1 --branch=main https://github.com/armbian/build.git build
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Compile Base Image
        id: compile
        working-directory: /builder/build
        run: |
          # 使用 nanopi-r4s (RK3399) 作为稳定底座，BRANCH 设为 current
          ./compile.sh RELEASE=${{ inputs.set_release }} BOARD=nanopi-r4s BRANCH=current BUILD_MINIMAL=no \
                       BUILD_ONLY=default HOST=armbian BUILD_DESKTOP=no EXPERT=yes KERNEL_CONFIGURE=no \
                       COMPRESS_OUTPUTIMAGE="sha" SHARE_LOG=yes
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Organize Files
        id: clean
        if: ${{ steps.compile.outputs.status == 'success' }}
        run: |
          git clone -q --single-branch --depth=1 --branch=main https://github.com/ophub/amlogic-s9xxx-armbian.git
          # 提取工具脚本
          cp -a amlogic-s9xxx-armbian/compile-kernel .
          chmod +x ${ROOTFS_SCRIPT}
          ${ROOTFS_SCRIPT} -v ${{ inputs.set_release }}
          echo "build_tag=Armbian_eaidk-610_${{ inputs.set_release }}" >> ${GITHUB_OUTPUT}
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Rebuild with RK3399 Kernel
        uses: ophub/amlogic-s9xxx-armbian@main
        if: ${{ steps.clean.outputs.status == 'success' }}
        with:
          build_target: armbian
          armbian_path: /builder/build/output/images/*.img.gz
          armbian_board: eaidk-610
          # 核心修改：强制指定内核包名包含 rk3399 关键字
          armbian_kernel: ${{ inputs.armbian_kernel }}
          auto_kernel: false
          kernel_repo: ophub/kernel
          kernel_usage: stable
          armbian_fstype: ext4

      - name: Upload Image to Release
        uses: ncipollo/release-action@main
        if: ${{ env.PACKAGED_STATUS == 'success' }}
        with:
          tag: ${{ steps.clean.outputs.build_tag }}
          artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### EAIDK-610 Armbian (RK3399) Latest Build
            - **Target:** Jellyfin Hardware Acceleration
            - **Kernel:** ${{ inputs.armbian_kernel }} (Includes RKMPP/VPU Driver)
            - **Device Nodes:** Expected `/dev/mpp_service` and `/dev/dri/renderD128`
            - **Base Config:** NanoPi R4S (Stable RK3399 Stack)
